name: Flutter CI

on:
  push:
    branches: [ master ]
    tags: [ '*' ]
  pull_request:
    branches: [ master ]

permissions:
  contents: write

jobs:
  build:
    name: Build and Test on Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Flutter action
        uses: subosito/flutter-action@v2.21.0
        with:
          channel: stable
      - name: Install dependencies
        run: flutter pub get
      - name: Analyze
        run: flutter analyze
      - name: Run tests
        run: flutter test
      - name: Remove WASM dependencies
        run: dart run pdfrx:remove_wasm_modules
  
  build-windows:
    name: Build Windows Release
    runs-on: windows-latest
    if: ${{ github.actor == 'nektos/act' || startsWith(github.ref, 'refs/tags/') }}
    steps:
      - uses: actions/checkout@v4
      - name: Flutter action
        uses: subosito/flutter-action@v2.21.0
        with:
          channel: stable
      - name: Install dependencies
        run: flutter pub get
      - name: Analyze
        run: flutter analyze
      - name: Run tests
        run: flutter test
      - name: Remove WASM dependencies
        run: dart run pdfrx:remove_wasm_modules
      - name: Build Windows Release
        run: flutter build windows --release
      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: veritium-windows-release
          path: build/windows/x64/runner/Release

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build-windows
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Windows Release Artifact
        uses: actions/download-artifact@v4
        with:
          name: veritium-windows-release
          path: dist

      - name: Zip Windows Release
        run: |
          cd dist
          zip -r ../veritium-windows-release.zip .

      - name: Zip Sample
        run: |
          cd examples/straza
          zip -r ../../sample.zip .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: "Automated release of the Veritium ${{ github.ref_name }}"
          draft: false
          prerelease: false
          files: |
            veritium-windows-release.zip
            sample.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
